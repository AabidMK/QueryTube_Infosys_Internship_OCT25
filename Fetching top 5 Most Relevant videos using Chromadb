# =========================================================
# Fetch Top 5 Most Relevant YouTube Videos using ChromaDB
# =========================================================

from sentence_transformers import SentenceTransformer
import chromadb

# Initialize embedding model (MiniLM-L6-v2)
model = SentenceTransformer("all-MiniLM-L6-v2")

# Connect to your existing ChromaDB database
client = chromadb.PersistentClient(path="./youtube_vector_db")
collection = client.get_collection(name="video_transcripts") # Corrected collection name

# Step 1ï¸âƒ£ Accept user query
query = input("Enter your search query: ")

# Step 2ï¸âƒ£ Convert query to embedding
query_embedding = model.encode(query).tolist()

# Step 3ï¸âƒ£ Search for top 5 similar videos
results = collection.query(
    query_embeddings=[query_embedding],
    n_results=5,
    include=["metadatas", "distances"] # Removed 'ids' from include
)

# Step 4ï¸âƒ£ Display results
print("\nğŸ” Top 5 Most Relevant Videos:\n")

# Accessing ids from the results dictionary (ids are returned by default)
ids = results.get('ids', [[]])[0]


for i, (vid, meta, score) in enumerate(
    zip(ids, results['metadatas'][0], results['distances'][0])
):
    # Print metadata keys for debugging
    print(f"Retrieving metadata keys: {meta.keys()}")
    print(f"{i+1}. ğŸ¬ Title: {meta['title']}")
    print(f"   ğŸ“º Channel: {meta['channel_title']}")
    print(f"   ğŸ†” Video ID: {vid}")
    print(f"   ğŸ§  Similarity Score: {round(1 - score, 3)}")  # Closer to 1 â†’ more similar
    print("-" * 60)

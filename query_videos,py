# query_videos.py
import chromadb

def search_videos():
    # Initialize ChromaDB client
    client = chromadb.PersistentClient(path="./chroma_db")
    collection = client.get_collection("youtube_videos")
    
    print(f"ğŸ“Š Database contains {collection.count()} videos")
    
    while True:
        print("\n" + "="*50)
        print("ğŸ¥ YOUTUBE VIDEO SEARCH")
        print("="*50)
        print("1. Search by keyword/topic")
        print("2. Search by channel")
        print("3. Get similar videos")
        print("4. Show random samples")
        print("5. Exit")
        
        choice = input("\nChoose an option (1-5): ").strip()
        
        if choice == "1":
            keyword_search(collection)
        elif choice == "2":
            channel_search(collection)
        elif choice == "3":
            similar_videos_search(collection)
        elif choice == "4":
            show_samples(collection)
        elif choice == "5":
            print("ğŸ‘‹ Goodbye!")
            break
        else:
            print("âŒ Invalid choice. Please try again.")

def keyword_search(collection):
    query = input("\nğŸ” Enter search keywords: ").strip()
    if not query:
        print("âŒ Please enter some keywords")
        return
    
    n_results = input("How many results? (default: 5): ").strip()
    n_results = int(n_results) if n_results.isdigit() else 5
    
    try:
        results = collection.query(
            query_texts=[query],
            n_results=n_results
        )
        
        print(f"\nğŸ“º Found {len(results['documents'][0])} results for '{query}':")
        print("-" * 60)
        
        for i, (doc, metadata, distance) in enumerate(zip(
            results['documents'][0], 
            results['metadatas'][0], 
            results['distances'][0]
        )):
            print(f"\n{i+1}. {metadata['title']}")
            print(f"   ğŸ“¹ Channel: {metadata['channel_title']}")
            print(f"   ğŸ‘€ Views: {int(metadata['view_count']):,}")
            print(f"   â±ï¸ Duration: {metadata['duration']}")
            print(f"   ğŸ†” Video ID: {metadata['video_id']}")
            print(f"   ğŸ“ Similarity: {1-distance:.3f}")
            print(f"   ğŸ“ Preview: {metadata.get('transcript_preview', 'No transcript')[:100]}...")
            
    except Exception as e:
        print(f"âŒ Search error: {e}")

def channel_search(collection):
    channel = input("\nğŸ¢ Enter channel name: ").strip()
    if not channel:
        print("âŒ Please enter a channel name")
        return
    
    # Get all videos and filter by channel
    all_videos = collection.get()
    channel_videos = []
    
    for i, metadata in enumerate(all_videos['metadatas']):
        if channel.lower() in metadata['channel_title'].lower():
            channel_videos.append({
                'metadata': metadata,
                'document': all_videos['documents'][i],
                'id': all_videos['ids'][i]
            })
    
    if not channel_videos:
        print(f"âŒ No videos found for channel '{channel}'")
        return
    
    # Sort by view count (descending)
    channel_videos.sort(key=lambda x: x['metadata']['view_count'], reverse=True)
    
    print(f"\nğŸ“º Found {len(channel_videos)} videos from '{channel}':")
    print("-" * 60)
    
    for i, video in enumerate(channel_videos[:10]):  # Show top 10
        metadata = video['metadata']
        print(f"\n{i+1}. {metadata['title']}")
        print(f"   ğŸ‘€ Views: {int(metadata['view_count']):,}")
        print(f"   â±ï¸ Duration: {metadata['duration']}")
        print(f"   ğŸ†” Video ID: {metadata['video_id']}")

def similar_videos_search(collection):
    video_id = input("\nğŸ¯ Enter video ID to find similar videos: ").strip()
    if not video_id:
        print("âŒ Please enter a video ID")
        return
    
    n_results = input("How many similar videos? (default: 5): ").strip()
    n_results = int(n_results) if n_results.isdigit() else 5
    
    try:
        # Get the target video's embedding
        target_video = collection.get(ids=[video_id])
        if not target_video['embeddings']:
            print(f"âŒ Video ID '{video_id}' not found")
            return
        
        # Find similar videos using the embedding
        results = collection.query(
            query_embeddings=target_video['embeddings'],
            n_results=n_results + 1  # +1 because the original will be included
        )
        
        print(f"\nğŸ” Similar videos to '{target_video['metadatas'][0]['title']}':")
        print("-" * 60)
        
        # Skip the first result (it's the original video)
        for i, (doc, metadata, distance) in enumerate(zip(
            results['documents'][0][1:], 
            results['metadatas'][0][1:], 
            results['distances'][0][1:]
        )):
            print(f"\n{i+1}. {metadata['title']}")
            print(f"   ğŸ“¹ Channel: {metadata['channel_title']}")
            print(f"   ğŸ‘€ Views: {int(metadata['view_count']):,}")
            print(f"   ğŸ“ Similarity: {1-distance:.3f}")
            
    except Exception as e:
        print(f"âŒ Error finding similar videos: {e}")

def show_samples(collection):
    n_samples = input("\nğŸ² How many random samples? (default: 5): ").strip()
    n_samples = int(n_samples) if n_samples.isdigit() else 5
    
    try:
        # Get all videos and sample randomly
        all_videos = collection.get()
        if len(all_videos['ids']) == 0:
            print("âŒ No videos in database")
            return
        
        import random
        sample_indices = random.sample(range(len(all_videos['ids'])), min(n_samples, len(all_videos['ids'])))
        
        print(f"\nğŸ² Random sample of {len(sample_indices)} videos:")
        print("-" * 60)
        
        for i, idx in enumerate(sample_indices):
            metadata = all_videos['metadatas'][idx]
            print(f"\n{i+1}. {metadata['title']}")
            print(f"   ğŸ“¹ Channel: {metadata['channel_title']}")
            print(f"   ğŸ‘€ Views: {int(metadata['view_count']):,}")
            print(f"   â±ï¸ Duration: {metadata['duration']}")
            print(f"   ğŸ†” Video ID: {metadata['video_id']}")
            
    except Exception as e:
        print(f"âŒ Error getting samples: {e}")

if __name__ == "__main__":
    search_videos()